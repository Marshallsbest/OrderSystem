<!DOCTYPE html>
<html>

<head>
  <base target="_self">
  <!-- Mobile Viewport Fix -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Material Design 3 -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">

  <!-- CSS Include -->
  <?!= include('css'); ?>

  <!-- Server-Injected Theme Override -->
  <style>
    :root {
      <? var main=categorySettings['main'] || categorySettings['Main'] || categorySettings['MAIN'];
      var mainColor="#32CD32"; // Default Brand Color
      var mainText="#ffffff"; // SAFE DEFAULT

      if (main) {
        mainColor=(typeof main==='object' && main.color) ? main.color: (typeof main==='string' ? main : mainColor);

        if (typeof main==='object' && main.textColor && String(main.textColor).trim() !=="") {
          mainText=String(main.textColor).trim();
        }

        else {
          var hex=String(mainColor).replace('#', '');

          if (hex.length===6) {
            var r=parseInt(hex.substr(0, 2), 16);
            var g=parseInt(hex.substr(2, 2), 16);
            var b=parseInt(hex.substr(4, 2), 16);
            var score=((r * 299) + (g * 587) + (b * 114)) / 1000;
            mainText=(score >=190) ? '#000000': '#ffffff';
          }
        }
      }

      if ( !mainText || mainText==="") mainText="#ffffff";
      ?>
    }

    .md3-top-app-bar {
      background-color: <?=mainColor ?> !important;
      color: <?=mainText ?> !important;
    }

    .md3-top-app-bar .md3-headline-medium,
    .md3-top-app-bar .md3-title-large {
      color: <?=mainText ?> !important;
    }

    .primary-btn,
    .md3-btn-filled {
      background-color: <?=mainColor ?> !important;
      color: <?=mainText ?> !important;
    }
  </style>
</head>

<body>
  <!-- App Bar -->
  <header class="md3-top-app-bar">
    <div class="md3-top-app-bar__content">
      <h1 class="md3-headline-medium">Order Form
        <?= version ?> âœ¨
      </h1>
      <div id="header-total" class="md3-title-large" style="font-weight: bold;">Total: $0.00</div>
    </div>
    <script>console.log('CLIENT_CATALOG_DEBUG_<?= version ?>:', typeof PRODUCT_CATALOG !== 'undefined' ? PRODUCT_CATALOG : 'NOT LOADED');</script>
  </header>

  <main class="md3-container">
    <!-- Login / Landing View -->
    <div id="login-view" class="state-view hidden">
      <h2 class="md3-headline-medium" style="margin-bottom: 24px;">Welcome</h2>
      <p class="md3-body-medium" style="margin-bottom: 16px;">Please enter your 6-digit Client ID to continue.</p>
      <div class="md3-text-field" style="max-width: 300px; margin: 0 auto 16px;">
        <input type="text" id="manual-client-id" placeholder=" " oninput="clearLoginError()">
        <label>Client ID</label>
      </div>
      <div id="login-error-msg" class="error-inline hidden"></div>
      <button class="md3-btn-filled" onclick="handleManualLogin()">Enter Store</button>
    </div>

    <!-- Details Modal/Bubble -->
    <div id="bubble-overlay" class="bubble-overlay" onclick="closeDetails()"></div>
    <div id="details-bubble" class="details-bubble">
      <div id="bubble-img-container" class="details-img-container">
        <!-- IMG injected here -->
      </div>
      <div id="bubble-title" class="details-title"></div>
      <div id="bubble-desc" class="details-desc"></div>
      <div style="text-align:right;">
        <button onclick="closeDetails()"
          style="border:none; background:none; color:#666; font-weight:bold; cursor:pointer;">CLOSE</button>
      </div>
    </div>

    <!-- Loading State (Full Screen Overlay) -->
    <div id="loading" class="loading-overlay">
      <span class="loader"></span>
      <p id="loading-text" style="margin-top: 20px; font-weight: 500;">Loading Store...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="state-view hidden">
      <span class="material-symbols-outlined error-icon">error</span>
      <p id="error-msg">Something went wrong.</p>
    </div>

    <!-- Order Form -->
    <form id="order-form" class="hidden">

      <!-- Client Info (Editable) -->
      <div id="client-info-container" style="display: flex; gap: 12px; margin-bottom: 24px;">
        <div class="md3-text-field">
          <input type="text" id="client-name-input" placeholder=" ">
          <label>Company Name</label>
        </div>
        <div class="md3-text-field">
          <input type="text" id="client-address-input" placeholder=" ">
          <label>Address</label>
        </div>
      </div>

      <!-- Product List -->
      <div id="product-list">
        <!-- Products injected here -->
      </div>

      <!-- FAB / Calculate Button -->
      <div class="fab-container">
        <div class="total-preview">
          <span>Total Pieces: <strong id="total-pieces">0</strong></span>
        </div>
        <button type="button" id="submit-btn" class="md3-btn-filled" onclick="reviewOrder()">
          Checkout
        </button>
      </div>
    </form>

    <!-- Review State -->
    <div id="review-view" class="state-view hidden"
      style="padding: 16px; max-width: 900px; margin: 0 auto; width: 100%; box-sizing: border-box;">
      <h2 class="md3-headline-medium" style="margin-bottom: 20px;">Review Your Order</h2>

      <!-- Table Container with horizontal scroll for mobile -->
      <div id="review-summary-container" style="overflow-x: auto; width: 100%;"></div>

      <!-- Client Info Summary (Optional, but good for verification) -->
      <div id="review-client-info"
        style="margin: 20px 0; text-align: left; padding: 15px; background: #f5f5f5; border-radius: 8px;">
        <!-- Populated by JS -->
      </div>

      <div style="display: flex; gap: 16px; justify-content: center; margin-top: 30px;">
        <button type="button" class="md3-btn-filled" style="background-color:#757575;"
          onclick="backToEdit()">Back</button>
        <button type="button" id="confirm-btn" class="md3-btn-filled" onclick="confirmOrder()">Confirm & Submit</button>
      </div>
    </div>

    <!-- Success State -->
    <div id="success" class="state-view hidden">
      <span class="material-symbols-outlined success-icon">check_circle</span>
      <h2>Order Received!</h2>
      <p>Your order has been placed successfully.</p>
    </div>

    <!-- Collapse All FAB -->
    <button class="md3-fab-fixed" id="collapse-fab" onclick="collapseAllCats()">
      <span class="material-symbols-outlined">unfold_less</span>
    </button>

  </main>

  <!-- JS Include -->
  <!-- Pass Client ID from server-side -->
  <script>
    // Inject Template Variables
    window.initialClientId = <?!= JSON.stringify(clientId) ?>;
    window.categorySettings = <?!= JSON.stringify(categorySettings) ?>;

    /**
     * Immediate Theme Application
     */
    (function () {
      const getContrastYIQ = (hex) => {
        if (!hex) return 'white';
        const r = parseInt(hex.substr(1, 2), 16);
        const g = parseInt(hex.substr(3, 2), 16);
        const b = parseInt(hex.substr(5, 2), 16);
        return (((r * 299) + (g * 587) + (b * 114)) / 1000 >= 190) ? 'black' : 'white';
      };

      const main = window.categorySettings ?
        (window.categorySettings['main'] || window.categorySettings['Main'] || window.categorySettings['MAIN']) : null;

      if (main) {
        const color = (typeof main === 'object') ? main.color : main;
        let text = (typeof main === 'object') ? main.textColor : '';
        if (!text || text === '#000000') text = getContrastYIQ(color);

        const root = document.documentElement;
        root.style.setProperty('--md-sys-color-primary', color);
        root.style.setProperty('--md-sys-color-on-primary', text);
      }
    })();
  </script>
  <?!= include('js'); ?>
  <!-- Version Footer -->
  <div style="text-align: center; color: #aaa; font-size: 12px; padding: 20px;">
    v1.6.06 [STABLE]
  </div>
</body>

</html>