<!DOCTYPE html>
<html>

<head>
  <base target="_self">
  <!-- Mobile Viewport Fix -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Material Design 3 -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">

  <!-- CSS Include -->
  <?!= include('css'); ?>
  <?!= include('admin_css'); ?>

  <!-- Server-Injected Theme Override (from APP_STYLES named ranges) -->
  <style>
    :root {
      <? var primaryColor=appStyles.primaryColor || "#FFA500";
      var primaryText=appStyles.primaryTextColor || "";
      var secondaryColor=appStyles.secondaryColor || "#625b71";
      var secondaryText=appStyles.secondaryTextColor || "";

      // Auto-compute text contrast if not explicitly set
      if ( !primaryText || primaryText==="") {
        var hex=String(primaryColor).replace('#', '');

        if (hex.length===6) {
          var r=parseInt(hex.substr(0, 2), 16);
          var g=parseInt(hex.substr(2, 2), 16);
          var b=parseInt(hex.substr(4, 2), 16);
          var score=((r * 299) + (g * 587) + (b * 114)) / 1000;
          primaryText=(score >=190) ? '#000000': '#ffffff';
        }

        else {
          primaryText='#ffffff';
        }
      }

      if ( !secondaryText || secondaryText==="") {
        var hex2=String(secondaryColor).replace('#', '');

        if (hex2.length===6) {
          var r2=parseInt(hex2.substr(0, 2), 16);
          var g2=parseInt(hex2.substr(2, 2), 16);
          var b2=parseInt(hex2.substr(4, 2), 16);
          var score2=((r2 * 299) + (g2 * 587) + (b2 * 114)) / 1000;
          secondaryText=(score2 >=190) ? '#000000': '#ffffff';
        }

        else {
          secondaryText='#ffffff';
        }
      }

      ?>--md-sys-color-primary: <?=primaryColor ?>;
      --md-sys-color-on-primary: <?=primaryText ?>;
      --md-sys-color-secondary: <?=secondaryColor ?>;
      --md-sys-color-on-secondary: <?=secondaryText ?>;
    }

    .md3-top-app-bar {
      background-color: <?=primaryColor ?> !important;
      color: <?=primaryText ?> !important;
    }

    .md3-top-app-bar .md3-headline-medium,
    .md3-top-app-bar .md3-title-large {
      color: <?=primaryText ?> !important;
    }

    .primary-btn,
    .md3-btn-filled {
      background-color: <?=primaryColor ?> !important;
      color: <?=primaryText ?> !important;
    }
  </style>
</head>

<body>
  <!-- App Bar -->
  <header class="md3-top-app-bar">
    <div class="md3-top-app-bar__content">
      <h1 class="md3-headline-medium">Order Form
        <?= version ?>
      </h1>
      <div id="header-total" class="md3-title-large" style="font-weight: bold;">Total: $0.00</div>
    </div>
    <!-- Navigation Tabs -->
    <div id="nav-tabs" class="md3-tabs hidden">
      <button class="md3-tab active" onclick="showView('order-form')">
        <span class="material-symbols-outlined">shopping_cart</span> New Order
      </button>
      <button class="md3-tab" onclick="showView('history-view')">
        <span class="material-symbols-outlined">history</span> Order History
      </button>
      <button id="admin-tab" class="md3-tab hidden" onclick="showView('admin-view', true)">
        <span class="material-symbols-outlined">settings</span> Admin
      </button>
    </div>
    <script>console.log('CLIENT_CATALOG_DEBUG_<?= version ?>:', typeof PRODUCT_CATALOG !== 'undefined' ? PRODUCT_CATALOG : 'NOT LOADED');</script>
  </header>

  <main class="md3-container">
    <!-- Login / Landing View -->
    <div id="login-view" class="state-view hidden">
      <h2 class="md3-headline-medium" style="margin-bottom: 24px;">Welcome</h2>
      <p class="md3-body-medium" style="margin-bottom: 16px;">Please enter your 6-digit Client ID to continue.</p>
      <div class="md3-text-field" style="max-width: 300px; margin: 0 auto 16px;">
        <input type="text" id="manual-client-id" placeholder=" " oninput="clearLoginError()">
        <label>Client ID</label>
      </div>
      <div id="login-error-msg" class="error-inline hidden"></div>
      <button class="md3-btn-filled" onclick="handleManualLogin()">Enter Store</button>
    </div>

    <!-- Details Modal/Bubble -->
    <div id="bubble-overlay" class="bubble-overlay" onclick="closeDetails()"></div>
    <div id="details-bubble" class="details-bubble">
      <div id="bubble-img-container" class="details-img-container">
        <!-- IMG injected here -->
      </div>
      <div id="bubble-title" class="details-title"></div>
      <div id="bubble-desc" class="details-desc"></div>
      <div style="text-align:right;">
        <button onclick="closeDetails()"
          style="border:none; background:none; color:#666; font-weight:bold; cursor:pointer;">CLOSE</button>
      </div>
    </div>

    <!-- Loading State (Full Screen Overlay) -->
    <div id="loading" class="loading-overlay">
      <span class="loader"></span>
      <p id="loading-text" style="margin-top: 20px; font-weight: 500;">Loading Store...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="state-view hidden">
      <span class="material-symbols-outlined error-icon">error</span>
      <p id="error-msg">Something went wrong.</p>
    </div>

    <!-- Order History View -->
    <div id="history-view" class="state-view hidden">
      <h2 class="md3-headline-medium" style="margin-bottom: 24px;">Load Previous Order</h2>
      <div style="max-width: 500px; margin: 0 auto; text-align: left;">
        <label class="md3-body-small" style="display: block; margin-bottom: 8px; opacity: 0.7;">Select an order to
          populate the form:</label>
        <select id="order-selector" class="md3-select" onchange="handleOrderSelection(this.value)">
          <option value="">-- Choose an Order --</option>
        </select>
        <p id="history-status" class="md3-body-small" style="margin-top: 12px; color: #888; text-align: center;"></p>
      </div>
    </div>

    <!-- Admin Dashboard View -->
    <div id="admin-view" class="state-view hidden">
      <?!= include('admin_form'); ?>
    </div>

    <!-- Order Form -->
    <form id="order-form" class="hidden">

      <!-- Client Info (Read-only display with update option) -->
      <div id="client-info-container" style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px;">
        <div style="display: flex; gap: 12px;">
          <div class="md3-text-field" style="flex:1;">
            <input type="text" id="client-name-input" placeholder=" " readonly>
            <label>Client Name</label>
          </div>
          <div class="md3-text-field" style="flex:1;">
            <input type="text" id="client-address-input" placeholder=" " readonly>
            <label>Delivery Address</label>
          </div>
        </div>
        <div style="display: flex; justify-content: flex-end; margin-top: 8px;">
          <button type="button" id="update-info-btn" class="md3-btn-outlined" onclick="showUpdateInfoModal()"
            style="white-space: nowrap; height: 40px; padding: 0 16px; display: flex; align-items: center; gap: 6px;">
            <span class="material-symbols-outlined" style="font-size: 18px;">edit</span>
            Update My Info
          </button>
        </div>
      </div>

      <!-- Update Info Modal -->
      <div id="update-info-modal" class="modal-overlay hidden" onclick="closeUpdateInfoModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
          <h3 class="md3-headline-small" style="margin-bottom: 20px;">Update My Information</h3>
          <p class="md3-body-small" style="margin-bottom: 16px; color: #666;">
            Submit your updated information for review. Changes will be applied after approval.
          </p>
          <div class="md3-text-field" style="margin-bottom: 16px;">
            <input type="text" id="update-client-id" placeholder=" ">
            <label>New Client ID</label>
          </div>
          <div class="md3-text-field" style="margin-bottom: 16px;">
            <input type="text" id="update-client-name" placeholder=" ">
            <label>Company Name</label>
          </div>
          <div
            style="background:#f5f5f5; padding:16px; border-radius:8px; margin-bottom:24px; border:1px solid #e0e0e0;">
            <label
              style="font-size:12px; font-weight:bold; display:block; margin-bottom:12px; color: var(--md-sys-color-primary);">DELIVERY
              ADDRESS</label>
            <div class="md3-text-field" style="margin-bottom:12px;">
              <input type="text" id="update-addr-street" placeholder=" ">
              <label>Street Address</label>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
              <div class="md3-text-field">
                <input type="text" id="update-addr-city" placeholder=" ">
                <label>City</label>
              </div>
              <div class="md3-text-field">
                <input type="text" id="update-addr-province" placeholder=" ">
                <label>Province</label>
              </div>
            </div>
            <div class="md3-text-field" style="max-width:200px;">
              <input type="text" id="update-addr-postal" placeholder=" ">
              <label>Postal Code</label>
            </div>
          </div>
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" class="md3-btn-outlined" onclick="closeUpdateInfoModal()">Cancel</button>
            <button type="button" class="md3-btn-filled" onclick="submitInfoUpdate()">Update</button>
          </div>
        </div>
      </div>

      <!-- Product List -->
      <div id="product-list">
        <!-- Products injected here -->
      </div>

      <!-- Special Instructions (at bottom of form) -->
      <div style="margin-top: 24px; margin-bottom: 16px;">
        <div class="md3-text-field">
          <input type="text" id="client-comments-input" placeholder=" ">
          <label>Special Instructions / Comments</label>
        </div>
      </div>

      <!-- FAB / Calculate Button -->
      <div class="fab-container">
        <button type="button" id="submit-btn" class="md3-btn-filled" onclick="reviewOrder()">
          Checkout
        </button>
      </div>
    </form>

    <!-- Review State -->
    <div id="review-view" class="state-view hidden"
      style="padding: 16px; max-width: 900px; margin: 0 auto; width: 100%; box-sizing: border-box;">
      <h2 class="md3-headline-medium" style="margin-bottom: 20px;">Review Your Order</h2>

      <!-- Table Container with horizontal scroll for mobile -->
      <div id="review-summary-container" style="overflow-x: auto; width: 100%;"></div>

      <!-- Client Info Summary (Optional, but good for verification) -->
      <div id="review-client-info"
        style="margin: 20px 0; text-align: left; padding: 15px; background: #f5f5f5; border-radius: 8px;">
        <!-- Populated by JS -->
      </div>

      <div style="display: flex; gap: 16px; justify-content: center; margin-top: 30px;">
        <button type="button" class="md3-btn-filled" style="background-color:#757575;"
          onclick="backToEdit()">Back</button>
        <button type="button" id="confirm-btn" class="md3-btn-filled" onclick="confirmOrder()">Confirm & Submit</button>
      </div>
    </div>

    <!-- Success State -->
    <div id="success" class="state-view hidden">
      <span class="material-symbols-outlined success-icon">check_circle</span>
      <h2>Order Received!</h2>
      <p>Your order has been placed successfully.</p>
    </div>

    <!-- Collapse All FAB -->
    <button class="md3-fab-fixed" id="collapse-fab" onclick="collapseAllCats()">
      <span class="material-symbols-outlined">unfold_less</span>
    </button>

  </main>

  <!-- JS Include -->
  <!-- Pass Client ID from server-side -->
  <script>
    // Inject Template Variables
    window.initialClientId = <?!= JSON.stringify(clientId) ?>;
    window.editOrderId = <?!= JSON.stringify(editOrderId) ?>;
    window.prefillData = <?!= JSON.stringify(prefillData) ?>;
    window.categorySettings = <?!= JSON.stringify(categorySettings) ?>;
    window.appConfig = <?!= JSON.stringify(appConfig) ?>;
    window.appStyles = <?!= JSON.stringify(appStyles) ?>;

    /**
     * Immediate Theme Application (from APP_STYLES named ranges)
     */
    (function () {
      const styles = window.appStyles || {};
      const root = document.documentElement;

      if (styles.primaryColor) {
        root.style.setProperty('--md-sys-color-primary', styles.primaryColor);
        root.style.setProperty('--md-sys-color-on-primary', styles.primaryTextColor || '#ffffff');
      }
      if (styles.secondaryColor) {
        root.style.setProperty('--md-sys-color-secondary', styles.secondaryColor);
        root.style.setProperty('--md-sys-color-on-secondary', styles.secondaryTextColor || '#ffffff');
      }
    })();
  </script>
  <?!= include('js'); ?>
  <?!= include('admin_logic'); ?>
  <!-- Version Footer -->
  <div style="text-align: center; color: #aaa; font-size: 12px; padding: 20px;">
    <?= version ?> [STABLE]
  </div>

  <!-- Snackbar Toast -->
  <div id="snackbar" class="md3-snackbar"></div>
</body>

</html>