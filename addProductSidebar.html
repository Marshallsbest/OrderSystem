<!-- 
  addProductSidebar.html 
  Version: v1.3.94
  Build Notes: Performance Optimization & Stall Fix
-->
<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Material Symbols -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* Version: v1.3.94 */
        :root {
            --md-sys-color-primary: #006c4c;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #89f8c6;
            --md-sys-color-on-primary-container: #002114;
            --md-sys-color-surface: #fbfdf9;
            --md-sys-color-surface-container: #edf2ea;
            --md-sys-color-on-surface: #191c1a;
            --md-sys-color-outline: #717974;
            --md-sys-color-outline-variant: #c0c9c2;
            --radius-md: 12px;
            --radius-sm: 8px;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            margin: 0;
            padding: 24px 16px;
        }

        h3 {
            margin: 0 0 24px 0;
            font-size: 22px;
            font-weight: 400;
            color: var(--md-sys-color-on-surface);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .version-tag {
            font-size: 10px;
            opacity: 0.5;
            font-weight: normal;
        }

        /* Material Input Field */
        .md3-input-wrapper {
            position: relative;
            margin-bottom: 24px;
        }

        .md3-input-wrapper input,
        .md3-input-wrapper textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 4px;
            /* Text field radius */
            background: transparent;
            font-family: inherit;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        .md3-input-wrapper input:focus,
        .md3-input-wrapper textarea:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            border-width: 2px;
            padding: 11px 15px;
            /* Adjust for border width change */
        }

        .md3-input-wrapper label {
            position: absolute;
            left: 14px;
            top: 13px;
            background-color: var(--md-sys-color-surface);
            padding: 0 4px;
            color: var(--md-sys-color-outline);
            font-size: 16px;
            transition: all 0.2s ease;
            pointer-events: none;
        }

        /* Floating Label Active State */
        .md3-input-wrapper input:focus~label,
        .md3-input-wrapper input:not(:placeholder-shown)~label,
        .md3-input-wrapper textarea:focus~label,
        .md3-input-wrapper textarea:not(:placeholder-shown)~label {
            top: -9px;
            font-size: 12px;
            color: var(--md-sys-color-primary);
            font-weight: 500;
        }

        /* Variations Section */
        .variation-card {
            background-color: var(--md-sys-color-surface-container);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            border: 1px solid var(--md-sys-color-outline-variant);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .variation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 12px;
            font-weight: 500;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .variation-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .compact-input label {
            display: block;
            font-size: 11px;
            color: var(--md-sys-color-outline);
            margin-bottom: 4px;
            font-weight: 500;
        }

        /* Compact inputs inside cards */
        .compact-input input,
        .compact-input select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            background: #fff;
            transition: all 0.2s;
        }

        .compact-input input:focus,
        .compact-input select:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 2px var(--md-sys-color-primary-container);
        }

        /* Buttons */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            width: 100%;
            margin-top: 16px;
        }

        .btn-filled {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .btn-filled:hover {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            opacity: 0.95;
        }

        .btn-filled:disabled {
            background-color: #E0E0E0;
            color: #9E9E9E;
            box-shadow: none;
            cursor: default;
        }

        .btn-tonal {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            margin-top: 24px;
        }

        .btn-tonal:hover {
            filter: brightness(0.95);
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            padding: 4px;
            border-radius: 50%;
        }

        .icon-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: #B00020;
        }

        .material-symbols-outlined {
            font-size: 20px;
        }

        .error {
            color: #B00020;
            font-size: 13px;
            margin-top: 8px;
        }

        .success {
            color: #006c4c;
            font-size: 13px;
            margin-top: 8px;
            font-weight: 500;
        }

        /* Transition */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <h3>Add New Product <span class="version-tag">v1.7.02</span> âœ¨</h3>

    <!-- Mode Switch -->
    <div style="margin-bottom: 20px; display: flex; gap: 8px; flex-wrap: wrap;">
        <label class="mode-btn">
            <input type="radio" name="mode" value="new" checked onchange="toggleMode()">
            <span>New Product</span>
        </label>
        <label class="mode-btn">
            <input type="radio" name="mode" value="existing" onchange="toggleMode()">
            <span>Add Variation</span>
        </label>
        <label class="mode-btn">
            <input type="radio" name="mode" value="edit" onchange="toggleMode()">
            <span>Edit Product</span>
        </label>
        <label class="mode-btn delete-mode">
            <input type="radio" name="mode" value="delete" onchange="toggleMode()">
            <span>Archive</span>
        </label>
    </div>

    <!-- Mode: Select Existing (For Add/Edit/Delete) -->
    <div id="existingSelectWrapper" class="md3-input-wrapper" style="display: none;">
        <select id="existingProduct" onchange="onExistingProductChange()"
            style="width: 100%; padding: 12px 16px; border: 1px solid var(--md-sys-color-outline); border-radius: 4px; background: transparent; font-family: inherit; font-size: 16px;">
            <option value="">Select a Base Product...</option>
        </select>
        <label style="background-color: var(--md-sys-color-surface);">Select Base Product</label>
    </div>

    <!-- Mode: Add (Form) -->
    <div class="md3-input-wrapper">
        <input type="text" id="brand" placeholder=" ">
        <label id="lbl_brand">Brand</label>
    </div>

    <div class="md3-input-wrapper">
        <input type="text" id="baseName" placeholder=" " required>
        <label id="lbl_name">Base Product Name</label>
    </div>

    <div class="md3-input-wrapper" id="wrap_zoneVariation" style="display:none;">
        <input type="text" id="zoneVariation" placeholder=" ">
        <label id="lbl_zoneVariation">Zone Variation Name</label>
    </div>

    <div class="md3-input-wrapper">
        <select id="category" onchange="onCategorySelectChange()">
            <option value="">Select Category...</option>
            <option value="NEW_CAT">+ Add New Category</option>
        </select>
        <label id="lbl_category">Category</label>
    </div>

    <div class="md3-input-wrapper">
        <input type="text" id="baseRef" placeholder=" " required>
        <label id="lbl_ref">Reference Character</label>
    </div>

    <div class="md3-input-wrapper">
        <input type="text" id="baseSku" placeholder=" " required>
        <label id="lbl_baseSku">Base SKU part</label>
    </div>

    <div id="varTypeContainer" style="margin-bottom: 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="md3-input-wrapper" style="margin-bottom:0;">
            <input type="text" id="var1Name" placeholder=" ">
            <label id="lbl_var1_name">Variation 1 Name</label>
        </div>
        <div class="md3-input-wrapper" style="margin-bottom:0;">
            <input type="text" id="var2Name" placeholder=" ">
            <label id="lbl_var2_name">Variation 2 Name</label>
        </div>

        <div class="md3-input-wrapper" style="margin-bottom:0;">
            <input type="text" id="var3Name" placeholder=" " value="Format">
            <label id="lbl_var3_name">Variation 3 Name</label>
        </div>
        <div class="md3-input-wrapper" style="margin-bottom:0;">
            <input type="text" id="var4Name" placeholder=" " value="Units">
            <label id="lbl_var4_name">Variation 4 Name</label>
        </div>
    </div>

    <div class="md3-input-wrapper">
        <input type="number" id="commissionRate" placeholder=" " step="0.01">
        <label id="lbl_commissionRate">Normal Commission ($)</label>
    </div>

    <div class="md3-input-wrapper">
        <input type="number" id="saleCommission" placeholder=" " step="0.01">
        <label id="lbl_saleCommission">Sale Commission ($)</label>
    </div>

    <div class="md3-input-wrapper">
        <textarea id="description" rows="2" placeholder=" "></textarea>
        <label id="lbl_description">Description (Optional)</label>
    </div>

    <div class="md3-input-wrapper">
        <input type="text" id="imageUrl" placeholder=" ">
        <label id="lbl_image">Image URL (Optional)</label>
    </div>

    <div class="md3-input-wrapper">
        <input type="text" id="baseColor" placeholder=" ">
        <label id="lbl_backgroundColor">Color (Hex/Name)</label>
    </div>

    <div id="variationList">
        <!-- Rows will go here -->
    </div>

    <button class="btn btn-tonal" onclick="addVariationRow()">
        <span class="material-symbols-outlined" style="margin-right:8px;">add</span>
        Add Variation
    </button>

    <button class="btn btn-filled" onclick="submitForm()" id="submitBtn">
        Submit Products
    </button>
    </div>

    <!-- Mode: Delete (List) -->
    <div id="deleteSection" style="display: none;">
        <p style="font-size:13px; color:#666; margin-bottom:12px;">Select variations to move to "DELETED_PRODUCTS":</p>
        <div id="deleteList"
            style="max-height: 300px; overflow-y:auto; border:1px solid #eee; padding:8px; border-radius:8px;">
            <div style="padding:16px; text-align:center; color:#999;">Select a Base Product above first.</div>
        </div>
        <button class="btn btn-filled" style="background-color:#B00020; margin-top:16px;" onclick="submitArchive()"
            id="archiveBtn">
            Archive Selected
        </button>
    </div>

    <div id="msg" class="error"></div>

    <style>
        .mode-btn {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid var(--md-sys-color-outline);
            font-size: 13px;
            font-weight: 500;
            color: #555;
            transition: all 0.2s;
        }

        .mode-btn input {
            display: none;
        }

        .mode-btn:has(input:checked) {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-color: var(--md-sys-color-primary);
        }

        .mode-btn.delete-mode:has(input:checked) {
            background-color: #ffebee;
            color: #b71c1c;
            border-color: #b71c1c;
        }
    </style>

    <script>
        let existingSkus = [];
        let baseProducts = [];
        let allCatalog = [];
        let categories = [];
        let headerMap = { labels: {}, indices: {} };

        window.onload = function () {
            // Fetch Categories
            google.script.run.withSuccessHandler(cats => {
                categories = cats;
                const select = document.getElementById('category');
                cats.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.name;
                    opt.textContent = c.name;
                    select.appendChild(opt);
                });
            }).getCategoryData();

            // Fetch Variation Defaults
            google.script.run.withSuccessHandler(defaults => {
                if (defaults.var1) document.getElementById('var1Name').value = defaults.var1;
                if (defaults.var2) document.getElementById('var2Name').value = defaults.var2;
                if (defaults.var3) document.getElementById('var3Name').value = defaults.var3;
                if (defaults.var4) document.getElementById('var4Name').value = defaults.var4;
            }).getVariationDefaults();

            // Fetch Header Map First for Dynamic Labels
            google.script.run.withSuccessHandler(map => {
                headerMap = map;
                updateLabels();
            }).getProductHeaderMap();

            google.script.run.withSuccessHandler(products => {
                allCatalog = products;
                existingSkus = products.map(p => p.sku);

                const map = new Map();
                products.forEach(p => {
                    if (!map.has(p.name)) {
                        map.set(p.name, p);
                    }
                });
                baseProducts = Array.from(map.values()).sort((a, b) => a.name.localeCompare(b.name));

                const select = document.getElementById('existingProduct');
                baseProducts.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.name;
                    opt.textContent = p.name;
                    select.appendChild(opt);
                });
            }).getProductCatalog();

            addVariationRow();
        };

        function updateLabels() {
            const labels = headerMap.labels;
            const indices = headerMap.indices;

            // Update Labels if found
            if (labels.name) document.getElementById('lbl_name').textContent = labels.name;
            if (labels.category) document.getElementById('lbl_category').textContent = labels.category;
            if (labels.description) document.getElementById('lbl_description').textContent = labels.description;
            if (labels.image) document.getElementById('lbl_image').textContent = labels.image;
            if (labels.backgroundColor) document.getElementById('lbl_backgroundColor').textContent = labels.backgroundColor;

            // Show/Hide Special Fields based on presence in sheet
            if (indices.zoneVariation !== undefined) {
                document.getElementById('wrap_zoneVariation').style.display = 'block';
                if (labels.zoneVariation) document.getElementById('lbl_zoneVariation').textContent = labels.zoneVariation;
            }
            if (indices.commissionRate !== undefined) {
                document.getElementById('wrap_commissionRate').style.display = 'block';
                if (labels.commissionRate) document.getElementById('lbl_commissionRate').textContent = labels.commissionRate;
            }
        }

        function toggleMode() {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const selectWrapper = document.getElementById('existingSelectWrapper');
            const addForm = document.getElementById('addFormSection');
            const deleteSection = document.getElementById('deleteSection');
            const baseNameInput = document.getElementById('baseName');
            const submitBtn = document.getElementById('submitBtn');

            // Reset Msg
            document.getElementById('msg').textContent = "";

            if (mode === 'new') {
                selectWrapper.style.display = 'none';
                addForm.style.display = 'block';
                deleteSection.style.display = 'none';
                baseNameInput.readOnly = false;
                document.getElementById('brand').value = "";
                document.getElementById('baseName').value = "";
                document.getElementById('baseRef').value = "";
                document.getElementById('baseSku').value = "";
                document.getElementById('var1Name').value = "";
                document.getElementById('var2Name').value = "";
                document.getElementById('var3Name').value = "";
                document.getElementById('var4Name').value = "";
                document.getElementById('zoneVariation').value = "";
                document.getElementById('category').value = "";
                document.getElementById('commissionRate').value = "";
                document.getElementById('description').value = "";
                document.getElementById('imageUrl').value = "";
                document.getElementById('baseColor').value = "";
                document.getElementById('variationList').innerHTML = "";
                addVariationRow(); // Start fresh
                submitBtn.textContent = "Submit Products";

            } else if (mode === 'existing') {
                selectWrapper.style.display = 'block';
                addForm.style.display = 'block';
                deleteSection.style.display = 'none';
                baseNameInput.readOnly = true;
                baseNameInput.style.backgroundColor = "#f0f0f0";
                onExistingProductChange();
                submitBtn.textContent = "Add Variations";

            } else if (mode === 'edit') {
                selectWrapper.style.display = 'block';
                addForm.style.display = 'block';
                deleteSection.style.display = 'none';

                // Allow Name Edit in Edit Mode? 
                // Creating a new name means renaming the group. 
                // Let's assume yes, but logic needs to handle it. 
                // Backend 'updateProductGroup' takes 'originalBaseName'.
                // So we need to store original name if we change it.
                // For safety, let's keep it read-only for now unless user requests Rename feature.
                // But normally "Edit Product" allows changing typos.
                baseNameInput.readOnly = false;
                baseNameInput.style.backgroundColor = "transparent";

                onExistingProductChange();
                submitBtn.textContent = "Save Changes";

            } else if (mode === 'delete') {
                selectWrapper.style.display = 'block';
                addForm.style.display = 'none';
                deleteSection.style.display = 'block';
                onExistingProductChange();
            }
        }

        function onExistingProductChange() {
            const name = document.getElementById('existingProduct').value;
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const list = document.getElementById('variationList');

            if (!name) {
                if (mode !== 'new') {
                    // clear fields
                }
                return;
            }

            // FILTER CATALOG for this product
            const products = allCatalog.filter(p => p.name === name);
            if (products.length === 0) return;

            // Separate Parent from Children
            const parentRow = products.find(p => p.isParent) || products[0];
            const variationRows = products.filter(p => !p.isParent);

            // Populate Info
            if (mode === 'existing' || mode === 'edit') {
                document.getElementById('brand').value = parentRow.brand || "";
                document.getElementById('baseName').value = parentRow.name;
                document.getElementById('baseName').dataset.original = parentRow.name;
                document.getElementById('baseRef').value = parentRow.ref || "";

                // For SKU, we might try to infer baseSku by splitting the first child's SKU?
                // Or just leave it blank for the user to define.
                if (variationRows.length > 0) {
                    const firstSku = variationRows[0].sku;
                    const parts = firstSku.split('-');
                    if (parts.length >= 2) document.getElementById('baseSku').value = parts[1];
                }

                document.getElementById('var1Name').value = parentRow.variation || "";
                document.getElementById('var2Name').value = parentRow.variation2 || "";
                document.getElementById('var3Name').value = parentRow.variation3 || "Format";
                document.getElementById('var4Name').value = parentRow.variation4 || "Units";



                document.getElementById('zoneVariation').value = parentRow.zoneVariation || "";
                document.getElementById('category').value = parentRow.category;
                document.getElementById('commissionRate').value = parentRow.commissionRate || "";
                document.getElementById('saleCommission').value = parentRow.saleCommission || "";
                document.getElementById('description').value = parentRow.description || "";
                document.getElementById('imageUrl').value = parentRow.image || "";
                document.getElementById('baseColor').value = parentRow.backgroundColor || "";
            }

            // Populate Variations
            if (mode === 'edit') {
                list.innerHTML = "";
                variationRows.forEach(p => {
                    addVariationRow(p);
                });
            } else if (mode === 'existing') {
                list.innerHTML = "";
                addVariationRow();
            }

            // Populate Delete List
            if (mode === 'delete') {
                const delList = document.getElementById('deleteList');
                delList.innerHTML = "";
                products.forEach(p => {
                    const label = document.createElement('label');
                    label.style = "display:flex; align-items:center; padding:8px; border-bottom:1px solid #eee; cursor:pointer;";
                    label.innerHTML = `
                        <input type="checkbox" class="del-check" value="${p.sku}" style="margin-right:12px;">
                        <div>
                            <div style="font-weight:500; font-size:14px;">${p.variation || "Standard"} ${p.variation2 ? " / " + p.variation2 : ""}</div>
                            <div style="font-size:12px; color:#666;">SKU: ${p.sku} | $${p.price}</div>
                        </div>
                    `;
                    delList.appendChild(label);
                });
            }
        }

        function submitArchive() {
            const checks = document.querySelectorAll('.del-check:checked');
            if (checks.length === 0) {
                document.getElementById('msg').textContent = "Select items to archive first.";
                return;
            }

            if (!confirm("Are you sure you want to archive " + checks.length + " items?")) return;

            const skus = Array.from(checks).map(c => c.value);
            const btn = document.getElementById('archiveBtn');
            const msg = document.getElementById('msg');

            btn.disabled = true;
            btn.textContent = "Archiving...";

            google.script.run
                .withSuccessHandler(res => {
                    btn.disabled = false;
                    btn.textContent = "Archive Selected";
                    if (res.success) {
                        msg.className = "success";
                        msg.textContent = "Archived " + res.count + " items.";
                        // Refresh data
                        allCatalog = allCatalog.filter(p => !skus.includes(p.sku));
                        onExistingProductChange();
                    } else {
                        msg.textContent = "Error: " + res.message;
                    }
                })
                .withFailureHandler(e => {
                    btn.disabled = false;
                    msg.textContent = "Sys Error: " + e.message;
                })
                .archiveProducts(skus);
        }

        function onGlobalFormatChange() {
            const fmt = document.getElementById('globalFormat').value;
            const unitsWrap = document.getElementById('caseUnitsWrapper');
            unitsWrap.style.display = (fmt === 'Single') ? 'none' : 'block';

            // If switching to Multi/Carton, maybe update existing rows? 
            // For now, let's assume it affects new rows added.
        }

        function onFormatChange(select) {
            const row = select.closest('.variation-card');
            const unitsWrapper = row.querySelector('.units-wrapper');
            if (select.value === 'Single') {
                unitsWrapper.style.display = 'none';
            } else {
                unitsWrapper.style.display = 'block';
            }
        }

        function onCategorySelectChange() {
            const select = document.getElementById('category');
            if (select.value === 'NEW_CAT') {
                // SUGGEST NEXT ORDER
                const maxOrder = categories.reduce((max, c) => Math.max(max, parseInt(c.order) || 0), 0);
                document.getElementById('newCatOrder').value = maxOrder + 1;
                document.getElementById('catModal').style.display = 'flex';
                select.value = ""; // Reset
            }
        }

        function closeCatModal() {
            document.getElementById('catModal').style.display = 'none';
        }

        function saveCategory() {
            const name = document.getElementById('newCatName').value.trim();
            const color = document.getElementById('newCatColor').value.trim();
            const sale = document.getElementById('newCatSale').checked;
            const order = document.getElementById('newCatOrder').value;

            if (!name) return alert("Name required");

            google.script.run.withSuccessHandler(() => {
                const select = document.getElementById('category');
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                opt.selected = true;
                select.appendChild(opt);
                closeCatModal();
            }).saveNewCategory({ name, color, saleActive: sale, order });
        }
        function addVariationRow(data = null) {
            const div = document.createElement('div');
            div.className = 'variation-card fade-in';
            const fmt = data ? (data.variation3 || 'Single') : 'Single';
            const units = data ? (data.unitsPerCase || 1) : 1;

            div.innerHTML = `
                <div class="variation-header">
                    <span style="font-weight:600; color:var(--md-sys-color-primary);">VARIATION ENTRY</span>
                    <button class="icon-btn" onclick="this.closest('.variation-card').remove()" title="Remove">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                </div>
                
                <div class="variation-grid" style="grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div class="compact-input">
                        <label>Val 1 (e.g. Flavor)</label>
                        <input type="text" class="var-v1" placeholder="Value 1" value="${data ? (data.variation || '') : ''}">
                    </div>
                    <div class="compact-input">
                        <label>Val 2</label>
                        <input type="text" class="var-v2" placeholder="Value 2" value="${data ? (data.variation2 || '') : ''}">
                    </div>

                    <div class="compact-input">
                        <label>Format</label>
                        <select class="var-v3" onchange="onFormatChange(this)" style="width:100%; padding:10px; border:1px solid var(--md-sys-color-outline-variant); border-radius:8px;">
                            <option value="Single" ${fmt === 'Single' ? 'selected' : ''}>Single Only</option>
                            <option value="Carton" ${fmt === 'Carton' ? 'selected' : ''}>Carton Only</option>
                            <option value="Multi" ${fmt === 'Multi' ? 'selected' : ''}>Multi (Split Single/Case)</option>
                        </select>
                    </div>
                    <div class="compact-input units-wrapper" style="display: ${fmt === 'Single' ? 'none' : 'block'};">
                        <label>Units per Case</label>
                        <input type="number" class="var-units" placeholder="e.g. 12" value="${units}">
                    </div>

                    <div class="compact-input">
                        <label>Price</label>
                        <input type="number" class="var-price" placeholder="Price" step="0.01" value="${data ? data.price : ''}">
                    </div>
                    <div class="compact-input">
                        <label>Sale Price</label>
                        <input type="number" class="var-sale" placeholder="Sale Price" step="0.01" value="${data ? data.salePrice : ''}">
                    </div>

                    <div style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" class="var-onsale" ${data && data.onSale ? 'checked' : ''}>
                        <label style="font-size:12px; font-weight:500;">On Sale</label>
                    </div>

                    <div class="compact-input" style="grid-column: span 2;">
                        <label>Variation Image URL (Optional)</label>
                        <input type="text" class="var-image" placeholder="Image URL" value="${data ? (data.image || '') : ''}">
                    </div>
                </div>
            `;
            document.getElementById('variationList').appendChild(div);
        }

        function autoCalcPrice(input) {
            const card = input.closest('.variation-card');
            const grid = card.querySelector('.variation-grid');
            const unitsInput = grid.querySelector('.var-units');
            const v4Hidden = grid.querySelector('.var-v4');
            if (v4Hidden && unitsInput) v4Hidden.value = unitsInput.value;

            const groupId = card.dataset.groupId;
            if (!groupId) return;

            const fmt = grid.querySelector('.var-v3').value;
            // If Product/Single row price changes, update Multi row
            if (fmt === 'Product' || fmt === 'Single') {
                const singlePrice = parseFloat(input.value) || 0;
                const allInGroup = document.querySelectorAll(`.variation-card[data-group-id="${groupId}"]`);
                allInGroup.forEach(c => {
                    const cGrid = c.querySelector('.variation-grid');
                    const cFmt = cGrid.querySelector('.var-v3').value;
                    if (cFmt === 'Multi' || cFmt === 'Carton') {
                        const units = parseFloat(cGrid.querySelector('.var-units').value) || 12;
                        const priceInput = cGrid.querySelector('.var-price');
                        if (priceInput) priceInput.value = (singlePrice * units).toFixed(2);
                    }
                });
            }
        }

        function syncMultiRows(input, className) {
            const card = input.closest('.variation-card');
            const groupId = card.dataset.groupId;
            if (!groupId) return;

            const allInGroup = document.querySelectorAll(`.variation-card[data-group-id="${groupId}"]`);
            allInGroup.forEach(c => {
                if (c === card) return;
                const target = c.querySelector('.' + className);
                if (!target) return;
                if (target.type === 'checkbox') {
                    target.checked = input.checked;
                } else {
                    target.value = input.value;
                    // Special: if image changes on one, it might be the same product
                    if (className === 'var-image') target.dispatchEvent(new Event('change'));
                }
            });
        }

        function submitForm() {
            const btn = document.getElementById('submitBtn');
            const msg = document.getElementById('msg');
            msg.textContent = "";
            msg.className = "error";
            const mode = document.querySelector('input[name="mode"]:checked').value;

            const brand = document.getElementById('brand').value.trim();
            const baseName = document.getElementById('baseName').value.trim();
            const originalName = document.getElementById('baseName').dataset.original || baseName;
            const baseRef = document.getElementById('baseRef').value.trim();
            const baseSku = document.getElementById('baseSku').value.trim();
            const var1Name = document.getElementById('var1Name').value.trim();
            const var2Name = document.getElementById('var2Name').value.trim();
            const var3Name = document.getElementById('var3Name').value.trim();
            const var4Name = document.getElementById('var4Name').value.trim();
            const zoneVariation = document.getElementById('zoneVariation').value.trim();
            const category = document.getElementById('category').value.trim();
            const commissionRate = document.getElementById('commissionRate').value.trim();
            const saleCommission = document.getElementById('saleCommission').value.trim();
            const desc = document.getElementById('description').value.trim();
            const img = document.getElementById('imageUrl').value.trim();
            const color = document.getElementById('baseColor').value.trim();

            if (!brand || !baseName || !category || !baseRef || !baseSku) {
                msg.textContent = "Please enter Brand, Name, Category, Ref and Base SKU.";
                return;
            }

            // Gather Variations
            const rows = document.querySelectorAll('.variation-card');
            const items = [];
            const batchSkus = new Set();
            let hasError = false;

            rows.forEach(row => {
                const v1 = row.querySelector('.var-v1').value.trim();
                const v2 = row.querySelector('.var-v2').value.trim();
                const v3 = row.querySelector('.var-v3').value.trim();
                const v4 = row.querySelector('.var-v4').value.trim();
                const price = row.querySelector('.var-price').value.trim();
                const sale = row.querySelector('.var-sale').value.trim();
                const vImage = row.querySelector('.var-image').value.trim();
                const onSale = row.querySelector('.var-onsale').checked;
                const units = row.querySelector('.var-units').value.trim();

                if (!price) {
                    msg.textContent = "Price required for all items.";
                    hasError = true;
                    return;
                }

                // SKU is now generated server-side, so no client-side SKU validation needed for new items.
                // For existing items in edit mode, the SKU is already part of the data.

                // LOGIC: Handle Multi Split
                if (v3 === 'Multi') {
                    const unitCount = parseFloat(units) || 12;
                    const basePrice = parseFloat(price) || 0;
                    const baseSale = parseFloat(sale) || 0;

                    const actualCasePrice = basePrice * unitCount;
                    const actualCaseSale = baseSale * unitCount;

                    // Add Single Item
                    items.push(createItemObject('Product', 1, basePrice, baseSale));
                    // Add Multi Item
                    items.push(createItemObject('Multi', unitCount, actualCasePrice, actualCaseSale));
                } else {
                    items.push(createItemObject(v3, units, price, sale));
                }

                function createItemObject(fmtValue, unitVal, p, s) {
                    return {
                        brand, name: baseName, category,
                        variation: v1, variation2: v2,
                        variation3: fmtValue, variation4: unitVal,
                        var1Name, var2Name, var3Name, var4Name,
                        ref: baseRef, baseSku, sku: "",
                        price: p, salePrice: s, onSale,
                        unitsPerCase: unitVal,
                        description: desc, image: vImage || img,
                        backgroundColor: color, zoneVariation,
                        commissionRate, saleCommission
                    };
                }
            });

            if (hasError) return;
            if (items.length === 0) {
                msg.textContent = "Add at least one variation.";
                return;
            }

            btn.disabled = true;
            btn.textContent = "Processing...";

            // Determine Action
            if (mode === 'edit') {
                const baseInfo = {
                    brand: brand,
                    name: baseName,
                    category,
                    ref: baseRef,
                    baseSku: baseSku,
                    var1Name, var2Name, var3Name, var4Name,
                    zoneVariation,
                    commissionRate,
                    saleCommission,
                    description: desc,
                    image: img,
                    color
                };
                google.script.run
                    .withSuccessHandler(res => {
                        btn.disabled = false;
                        if (res.success) {
                            msg.className = "success";
                            msg.textContent = "Updated " + res.updated + " items, Added (" + res.added + ").";
                            // Optionally refresh catalog logic
                        } else {
                            msg.textContent = "Error: " + res.message;
                        }
                    })
                    .withFailureHandler(e => {
                        btn.disabled = false;
                        msg.textContent = "Sys Error: " + e.message;
                    })
                    .updateProductGroup(originalName, baseInfo, items);

            } else {
                // ADD NEW REQ
                // We check dupe again inside backend usually, but client side check is safer.
                google.script.run
                    .withSuccessHandler(res => {
                        btn.disabled = false;
                        if (res.success) {
                            msg.className = "success";
                            msg.textContent = "Success! Added " + res.count + " items.";
                            if (mode === 'new') {
                                document.getElementById('baseName').value = "";
                                document.getElementById('zoneVariation').value = "";
                                document.getElementById('commissionRate').value = "";
                                document.getElementById('variationList').innerHTML = "";
                                addVariationRow();
                            }
                            // Add to local SKUs
                            items.forEach(i => {
                                allCatalog.push(i);
                                existingSkus.push(i.sku);
                            });
                        } else {
                            msg.textContent = "Error adding products.";
                        }
                    })
                    .withFailureHandler(e => {
                        btn.disabled = false;
                        msg.textContent = "Error: " + e.message;
                    })
                    .addProductBatch(items);
            }
        }
    </script>
    <!-- CATEGORY MODAL -->
    <div id="catModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div class="md3-card" style="width:300px; padding:20px; background:white;">
            <h3>New Category</h3>
            <div class="md3-input-wrapper">
                <input type="text" id="newCatName" placeholder=" ">
                <label>Category Name</label>
            </div>
            <div class="md3-input-wrapper">
                <input type="text" id="newCatColor" placeholder="#000000">
                <label>Hex Color</label>
            </div>
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:16px;">
                <input type="checkbox" id="newCatSale">
                <label>Sale Active</label>
            </div>
            <div class="md3-input-wrapper">
                <input type="number" id="newCatOrder" placeholder="99">
                <label>Display Order</label>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:8px;">
                <button class="md3-button-text" onclick="closeCatModal()">Cancel</button>
                <button class="md3-button-primary" onclick="saveCategory()">Save</button>
            </div>
        </div>
    </div>
</body>

</html>