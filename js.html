<script>
    /**
     * Global State
     */
    let PRODUCT_CATALOG = [];
    let CURRENT_CLIENT = null;

    /**
     * Initialize
     */
    window.onload = function () {
        if (!CLIENT_ID) {
            // No ID in URL -> Show Login View
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('login-view').classList.remove('hidden');
            return;
        }

        // 1. Fetch Client Data
        fetchClientData(CLIENT_ID);
    };

    /**
     * Handle Manual Login
     */
    function handleManualLogin() {
        const input = document.getElementById('manual-client-id');
        const id = input.value.trim();

        if (!id) {
            alert("Please enter a Client ID.");
            return;
        }

        // Hide Login, Show Loading
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('loading').classList.remove('hidden');

        // Update Global and Fetch
        // We act as if it came from URL
        fetchClientData(id);
    }

    function fetchClientData(id) {
        google.script.run
            .withSuccessHandler(onClientDataSuccess)
            .withFailureHandler(onLoginFailure)
            .getClientById(id);
    }

    function onLoginFailure(error) {
        // If specific login fail
        showError("Invalid Client ID or System Error.");
        // Optional: Provide "Try Again" button to go back to Login View
        // For now, showError is terminal state in existing code, but let's allow retry?
        // Let's just reset to login view after alert for better UX in this specific flow
        document.getElementById('error').innerHTML += `<br><button class="md3-btn-filled" onclick="location.reload()">Try Again</button>`;
    }

    function onClientDataSuccess(client) {
        if (!client) {
            showError("Client not found in database.");
            return;
        }

        CURRENT_CLIENT = client;
        document.getElementById('client-name').textContent = client['Name'] || "Unknown Client";
        document.getElementById('client-details').textContent = client['Address'] || ""; // Or other fields

        // 2. Fetch Products
        google.script.run
            .withSuccessHandler(onProductsSuccess)
            .withFailureHandler(onFailure)
            .getProductCatalog();
    }

    function onProductsSuccess(products) {
        PRODUCT_CATALOG = products;
        renderProducts(products);

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('order-form').classList.remove('hidden');
    }

    /**
     * Render Product List
     */
    /**
     * Render Product List grouped by Category
     */
    function renderProducts(products) {
        const container = document.getElementById('product-list');
        container.innerHTML = "";

        // 1. Group products by Category
        const grouped = {};
        products.forEach(p => {
            const cat = p.category || "Uncategorized";
            if (!grouped[cat]) grouped[cat] = [];
            grouped[cat].push(p);
        });

        // 2. Sort Categories (optional, alphabetical)
        const categories = Object.keys(grouped).sort();

        // 3. Render Groups
        categories.forEach(cat => {
            // Category Header
            const retSection = document.createElement('section');
            retSection.innerHTML = `<h2 class="md3-title-large" style="margin-top: 24px;">${cat}</h2>`;
            container.appendChild(retSection);

            // Render Items in this category
            grouped[cat].forEach(p => {
                const card = document.createElement('div');
                card.className = "md3-card";

                // Determine label
                const title = p.name + (p.variation ? ` - ${p.variation}` : "");
                const priceDisplay = p.price ? `$${p.price}` : "";

                card.innerHTML = `
        <div class="card-content">
          <h3 class="md3-title-large" style="font-size: 16px;">${title}</h3>
          <p class="md3-body-medium">SKU: ${p.sku} | ${priceDisplay}</p>
          
          <div class="qty-input-group">
            <!-- Units Input -->
            <div class="md3-text-field">
              <label>Units</label>
              <input type="number" min="0" data-sku="${p.sku}" data-type="unit" class="qty-input" placeholder="0">
            </div>
            
             ${p.unitsPerCase ? `
            <div class="md3-text-field">
              <label>Cases (x${p.unitsPerCase})</label>
              <input type="number" min="0" data-sku="${p.sku}" data-per-case="${p.unitsPerCase}" data-type="case" class="qty-input" placeholder="0">
            </div>
            ` : ''}
          </div>
        </div>
      `;
                container.appendChild(card);
            });
        });

        // Attach Listeners
        const inputs = document.querySelectorAll('.qty-input');
        inputs.forEach(input => {
            input.addEventListener('input', calculateTotal);
        });
    }

    /**
     * Calculate Totals
     */
    function calculateTotal() {
        let totalPieces = 0;

        const inputs = document.querySelectorAll('.qty-input');
        inputs.forEach(input => {
            const val = parseInt(input.value) || 0;
            if (val > 0) {
                if (input.dataset.type === 'case') {
                    const perCase = parseInt(input.dataset.perCase) || 1;
                    totalPieces += (val * perCase);
                } else {
                    totalPieces += val;
                }
            }
        });

        document.getElementById('total-pieces').textContent = totalPieces;
    }

    /**
     * Submit Order
     */
    function submitOrder() {
        const inputs = document.querySelectorAll('.qty-input');
        const itemsMap = {}; // Map sku to total qty

        // Aggregate quantities by SKU
        inputs.forEach(input => {
            const val = parseInt(input.value) || 0;
            if (val > 0) {
                const sku = input.dataset.sku;
                if (!itemsMap[sku]) itemsMap[sku] = 0;

                if (input.dataset.type === 'case') {
                    const perCase = parseInt(input.dataset.perCase) || 1;
                    itemsMap[sku] += (val * perCase);
                } else {
                    itemsMap[sku] += val;
                }
            }
        });

        const items = Object.keys(itemsMap).map(sku => ({
            sku: sku,
            quantity: itemsMap[sku] // Total units
        }));

        if (items.length === 0) {
            alert("Please add at least one item.");
            return;
        }

        // Disable UI
        const btn = document.getElementById('submit-btn');
        btn.disabled = true;
        btn.textContent = "Submitting...";

        const payload = {
            clientId: CLIENT_ID,
            items: items,
            totalPieces: document.getElementById('total-pieces').textContent
        };

        google.script.run
            .withSuccessHandler(onOrderSuccess)
            .withFailureHandler(onFailure)
            .processOrder(payload);
    }

    function onOrderSuccess(response) {
        document.getElementById('order-form').classList.add('hidden');
        document.getElementById('success').classList.remove('hidden');
        // Optionally show PDF link if returned (it is!)
        if (response.pdfUrl) {
            const p = document.createElement('p');
            p.innerHTML = `<a href="${response.pdfUrl}" target="_blank">Download PDF Receipt</a>`;
            document.getElementById('success').appendChild(p);
        }
    }

    function onFailure(error) {
        showError("Error: " + error.message);
        const btn = document.getElementById('submit-btn');
        btn.disabled = false;
        btn.textContent = "Submit Order";
    }

    function showError(msg) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error').classList.remove('hidden');
        document.getElementById('error-msg').textContent = msg;
    }
</script>